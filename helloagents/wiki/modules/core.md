# core

## 目的
提供统一的命令路由、对话状态机、权限校验与审计能力，屏蔽具体服务差异。

## 模块概述
- **职责:** 解析用户意图（消息/按钮事件）、维护交互状态、触发适配器动作、生成回复内容
- **状态:** 🚧开发中
- **最后更新:** 2026-01-13

## 规范

### 需求: 多步交互状态机
**模块:** core
支持“选择动作 → 输入参数 → 二次确认 → 执行 → 回显”的状态流转，包含 TTL 超时与取消。
- TTL：可通过配置 `core.state_ttl` 调整（默认 30m）。
- 过期清理：StateStore 内置后台 janitor 定期清理过期 key，避免仅依赖 `Get()` 的懒惰删除导致内存长期占用。
- 模板卡片文本兜底：当企业微信客户端不支持展示模板卡片时，可通过 `wecom.template_card_mode: both|text` 启用“文本菜单 + 回复序号映射 EventKey”，避免交互中断。

### 需求: 多服务 Provider 分发
**模块:** core
以 Provider 形式承载不同后端服务（如 Unraid、青龙），core 负责统一鉴权、会话状态与消息分发，避免核心路由随服务数量膨胀。

### 需求: 权限与审计
**模块:** core
提供用户白名单/简单角色控制，危险操作二次确认，输出结构化审计日志。

### 需求: 入口指令
**模块:** core
支持在应用会话中输入关键词打开菜单（如“容器”/“菜单”/“unraid”），并在会话过期时给出明确提示。

## API接口
本模块不直接对外提供 HTTP API，通过内部接口供 `wecom` 调用。

## 数据模型
参见 `wiki/data.md` 的会话状态与审计事件。

## 依赖
- wecom
- unraid
- qinglong

## 变更历史
- 2026-01-12: 初始化 core 路由与会话状态机（内存 + TTL）
- 2026-01-12: 引入 Provider 插件框架与服务选择菜单（兼容 Unraid 直达入口）
- 2026-01-12: StateStore 增加后台定时清理，治理过期状态长期驻留
- 2026-01-13: 新增模板卡片文本兜底：回复序号触发同等 EventKey（解决模板卡片不展示导致无响应）
