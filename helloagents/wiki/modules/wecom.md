# wecom

## 目的
对接企业微信自建应用回调能力：验签、解密、解析消息/事件，发送文本/卡片消息并处理用户交互。

## 模块概述
- **职责:** 回调入口（GET 校验 + POST 消息/事件）；加解密与签名校验；调用企业微信 API 发送消息/卡片
- **状态:** 🚧开发中
- **最后更新:** 2026-01-13

## 规范

### 需求: 回调安全
**模块:** wecom
必须校验回调签名，解密成功后才进入业务处理；错误场景返回可诊断但不泄露敏感信息的响应。
- 回调入口限制请求体大小（默认 1MiB），避免恶意超大 body 导致资源耗尽。
- 对回调消息做短期去重（按 TaskId/MsgId/明文哈希），吸收企业微信重试并避免重复执行业务逻辑。
- 加解密遵循 WXBizMsgCrypt：签名为 SHA1(sort(token,timestamp,nonce,encrypt))；AES-CBC(iv=key[:16])；PKCS7 padding blockSize=32。

### 需求: access_token 缓存与并发刷新治理
**模块:** wecom
发送消息前需要获取 `access_token`：
- 本地缓存 token 与过期时间
- 并发场景使用 singleflight 合并刷新请求，避免 token 过期时的“缓存击穿”与上游限流风险

### 需求: 交互式卡片/按钮
**模块:** wecom
以卡片承载“动作选择/确认”，以会话文本承载“参数输入”，并能关联到 core 的会话状态机。

### 需求: 多服务菜单
**模块:** wecom
支持“服务选择/实例选择/任务选择”等交互卡片，配合 core 的 Provider 分发实现多后端服务的统一入口。

### 需求: 应用自定义菜单
**模块:** wecom
支持企业微信自建应用“底部菜单”（menu/create），并可消费 `CLICK` 事件，将菜单点击映射到 core 的路由与命令体系。

## API接口
对外 HTTP 入口见 `wiki/api.md`。

## 交互文档
- [企业微信自建应用会话交互速查](../wecom_interaction.md)
- 收发自检：白名单用户发送 `ping`/`/ping` 或 `自检`（或点击菜单“自检”），收到 `pong` 回复即说明收消息与发消息链路正常。
- 帮助：发送 `帮助`/`help` 可查看可用命令；发送 `同步菜单` 可创建/覆盖应用自定义菜单。

## 数据模型
无独立持久化数据；读取 Config 并透传到 core。

## 依赖
- core

## 变更历史
- 2026-01-12: 回调验签/解密与应用消息发送（含 access_token 缓存）
- 2026-01-12: 新增服务选择与青龙(QL)交互卡片（实例选择/动作菜单/任务选择）
- 2026-01-12: access_token 刷新引入 singleflight，抑制并发刷新击穿
- 2026-01-13: 模板卡片按钮回调消费 ResponseCode，调用 update_template_card 更新按钮为不可点击状态
- 2026-01-13: 修复 PKCS7 padding blockSize 与官方一致（32），解决回调解密 invalid pkcs7 padding
- 2026-01-13: 新增应用自定义菜单同步（menu/create）与 CLICK 事件支持；补充帮助与斜杠命令
- 2026-01-13: 模板卡片补齐 source 字段，提升客户端兼容性（避免发送成功但不展示）
