# 变更提案: PVE 接入企业微信（资源查询 / VM&LXC 管理 / 告警通知）

## 需求背景
当前 wecom-home-ops 已支持 Unraid 与青龙(QL) 的企业微信交互，但家庭运维中 PVE（Proxmox VE）同样是高频面板：节点资源、存储水位、虚拟机/容器启停等需要在手机端快速完成。将 PVE 接入现有 Provider 框架，可统一入口、复用白名单鉴权与会话状态机，并通过告警推送实现“发现问题 → 进入详情 → 处置/静默”的闭环。

## 变更内容
1. 新增 PVE Provider（支持多实例）：资源与健康查询、VM/LXC 日常管理（启动/关机/重启/强制停止）
2. 新增 PVE 告警轮询：存储使用率、CPU/内存使用率阈值告警推送（通知对象沿用 `auth.allowed_userids`）
3. 扩展企业微信底部自定义菜单：在“常用”中增加 PVE 入口，并保留现有菜单结构
4. 同步更新知识库：配置说明、交互说明、模块文档与 Changelog

## 影响范围
- **模块:** core / wecom / app / config /（新增）pve
- **文件:** `internal/pve/*`、`internal/app/server.go`、`internal/config/config.go`、`internal/wecom/message.go`、`helloagents/wiki/*`
- **API:** 对外 HTTP 无新增；内部新增调用 PVE API
- **数据:** 无持久化；告警静默/冷却状态为内存态（随进程重启清空）

## 核心场景

### 需求: 资源与健康查询
**模块:** pve + wecom
通过企业微信快速查看集群/节点资源概览、节点在线状态、存储使用率等信息。

#### 场景: 一键查看资源概览
- 从“底部菜单/PVE/操作菜单”进入 PVE
- 选择实例（多实例时）
- 查看：节点在线、CPU/内存水位、存储水位（按阈值高亮提示）

### 需求: VM/LXC 日常管理
**模块:** pve + core + wecom
首期支持 VM 与 LXC 的：启动/关机(Shutdown)/重启(Reboot)/强制停止(Stop)，并强制二次确认。

#### 场景: 搜索并重启 VM/LXC
- 选择“VM 管理 / LXC 管理”与动作（重启）
- 输入 VMID 或名称关键词
- 若命中多个目标：列表选择
- 二次确认后执行，并回显结果（包含目标、节点、任务信息/失败原因）

### 需求: 告警与通知闭环
**模块:** pve + wecom
周期轮询检测阈值告警并推送到白名单用户；在 PVE 菜单中可查看当前阈值状态，并提供“静默/解除静默”能力避免刷屏。

#### 场景: 存储水位告警处理
- 超阈值触发告警：企业微信收到告警文本通知（带实例/节点/存储/水位）
- 用户进入 PVE → 查看详情（确认当前状态）
- 如短期可忽略：在 PVE 菜单中“静默告警（例如 30m）”

## 风险评估
- **风险:** 远程执行 Stop/Reboot 属高影响操作，误触会造成业务中断
- **缓解:** 强制二次确认；白名单鉴权；事件 key 与用户输入严格校验；配置层支持限制范围（预留 allowlist/前缀策略）
- **风险:** 告警轮询导致刷屏或误报
- **缓解:** 冷却时间（cooldown）+ 静默（mute）+ 默认阈值与轮询间隔可配置
