# 变更提案: Unraid 容器状态/资源/日志查看

## 需求背景
当前 wecom-home-ops 已支持 Unraid 容器的重启/停止/强制更新，但缺少“可观测性”能力：当容器出现异常或需要排查问题时，仍需打开 Unraid Web UI 才能查看状态、运行时长、资源使用与日志，移动端操作成本较高。

本变更旨在将常用排查信息以企业微信会话形式快速回显，减少排障链路与时间成本。

## 产品分析

### 目标用户与场景
- **用户群体:** 家庭运维/自建服务维护者（少量管理员，已通过企业微信白名单控制）
- **使用场景:** 在手机端快速确认指定容器是否运行、运行多久、资源是否异常、最近日志是否有报错
- **核心痛点:** 需要切换到浏览器进入 Unraid 管理界面；信息分散且获取步骤多

### 价值主张与成功指标
- **价值主张:** 在企业微信中“一次指令/一次点击”即可获得排障关键信息
- **成功指标:** 排查路径从「打开 Web UI → 搜索容器 → 查看页面」缩短为「会话内查询 → 直接回显」，并在常见问题下可在 1 分钟内完成初步判断

### 人文关怀
仅面向白名单用户提供能力；对日志与资源详情进行长度截断与必要脱敏提示，避免在会话中无意泄露敏感信息。

## 变更内容
1. 企业微信交互新增“查看状态/资源概览/资源详情/查看日志”动作，且支持文字命令直达。
2. unraid 模块增加容器信息查询能力：优先使用 Unraid Connect GraphQL API，并通过 introspection 自动探测 stats/logs 字段支持度。
3. 统一输出格式：运行时长从 `status` 字符串解析；日志默认 50 行并支持指定行数；所有回显做长度控制与失败原因可读化。

## 影响范围
- **模块:** core / wecom / unraid
- **文件:** `internal/core/*`、`internal/wecom/*`、`internal/unraid/client.go`
- **API:** 无（仍为内部能力，通过企业微信会话交互触发）
- **数据:** 无新增持久化数据

## 核心场景

### 需求: 状态查看
**模块:** core / unraid / wecom
查看指定容器的运行状态与运行时长。

#### 场景: 卡片按钮查看
用户在菜单中点击“查看状态”，输入容器名。
- 回显 state/status 与从 status 解析的运行时长（如 `Up 3 hours`）

#### 场景: 文本命令查看
用户发送 `状态 <容器名>`。
- 直接回显状态与运行时长

### 需求: 资源概览
**模块:** core / unraid / wecom
查看指定容器的资源使用概览（CPU/内存/网络/磁盘IO/PIDs）。

#### 场景: 卡片按钮查看
用户点击“资源概览”，输入容器名。
- 若 GraphQL 支持 stats：回显关键指标（概览）
- 若不支持：回显“当前 GraphQL API 不支持资源查询”的可读原因与建议

#### 场景: 文本命令查看
用户发送 `资源 <容器名>`。
- 同上

### 需求: 资源详情
**模块:** core / unraid / wecom
查看指定容器的资源使用详情（尽可能完整展示 stats 字段）。

#### 场景: 卡片按钮查看
用户点击“资源详情”，输入容器名。
- 回显更完整的字段；若超长则截断并提示

#### 场景: 文本命令查看
用户发送 `详情 <容器名>` 或 `资源详情 <容器名>`。
- 同上

### 需求: 最新日志
**模块:** core / unraid / wecom
查看指定容器的最新日志，默认 50 行，支持指定行数。

#### 场景: 卡片按钮查看
用户点击“查看日志”，输入 `容器名 [行数]`（行数可选）。
- 默认 50 行；支持指定行数；超长截断

#### 场景: 文本命令查看
用户发送 `日志 <容器名> [行数]`。
- 同上

## 风险评估
- **风险:** Unraid GraphQL API 对 stats/logs 字段支持度不确定，可能因插件版本差异缺失
  - **缓解:** 通过 introspection 探测能力；缺失时返回明确提示（不做 SSH 兜底，符合方案1约束）
- **风险:** 企业微信消息长度限制导致日志/详情被截断
  - **缓解:** 统一做长度与行数控制，末尾提示“已截断”
- **风险:** 误操作与权限问题
  - **缓解:** 复用既有白名单校验；对“操作类动作”保留二次确认，对“查看类动作”不需要确认
