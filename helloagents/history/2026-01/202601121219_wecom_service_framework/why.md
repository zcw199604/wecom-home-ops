# 变更提案: 企业微信多服务插件框架 + 青龙(QL)对接

## 需求背景
当前 `wecom-home-ops` 已支持企业微信自建应用回调与会话交互，并实现了对 Unraid 容器管理的接入。随着家庭/个人运维场景扩展（如青龙面板任务管理），继续在 `core.Router` 中为每个服务“直接堆逻辑”会导致：
- 路由复杂度快速增长，状态机与交互卡片难以复用
- 新服务接入需要改动核心路由与已有流程，回归风险增大
- 多实例（多个面板/多个环境）支持缺乏统一抽象

因此需要引入“多服务插件框架”，将不同后端服务（Unraid、青龙等）的能力以 Provider 方式注册到核心路由中，在保持现有能力可用的前提下，新增青龙 OpenAPI 的全功能对接与多实例支持。

## 产品分析

### 目标用户与场景
- **用户群体:** 个人/家庭运维人员（自建服务维护者）
- **使用场景:** 在手机企业微信里快速执行日常运维动作（无需 VPN/网页登录面板/多端切换）
- **核心痛点:** 操作入口分散；面板切换成本高；执行结果难以在同一会话中闭环

### 价值主张与成功指标
- **价值主张:** 用企业微信会话把“选择实例→选择动作→输入/选择参数→二次确认→执行回显”做成统一交互
- **成功指标:**
  - 可在企微会话中完成青龙任务：查询/搜索、运行、启用、禁用、查看最近日志
  - 支持配置多个青龙实例并在会话内选择
  - 现有 Unraid 功能不被破坏，且可复用同一套交互与状态机基础设施

### 人文关怀
尽量减少用户在移动端输入复杂参数的负担（提供按钮/列表选择优先），并避免在日志与消息中暴露敏感信息（client_secret、token 等）。

## 变更内容
1. 引入多服务 Provider 框架：核心路由只负责鉴权、会话管理与分发，服务逻辑下沉到 Provider。
2. 将现有 Unraid 能力迁移为 Unraid Provider，保持原有入口关键词与交互体验。
3. 新增青龙 Provider：
   - 支持多实例配置与会话内实例选择
   - 通过青龙 OpenAPI（`/open/auth/token`）获取并缓存 token
   - 支持任务查询/搜索、运行、启用、禁用、查看最近日志
4. 扩展企业微信交互卡片：服务选择、实例选择、动作菜单、任务选择与二次确认。
5. 增强安全策略：白名单鉴权、事件 key 校验、输入校验、敏感信息不落日志。

## 影响范围
- **模块:**
  - `internal/core`（路由/会话/Provider 注册与分发）
  - `internal/wecom`（卡片与事件 key 扩展）
  - `internal/unraid`（迁移为 Provider 适配）
  - `internal/qinglong`（新增）
  - `internal/config` / `internal/app`（配置与装配）
- **文件:**
  - `config.example.yaml`
  - `internal/config/config.go`
  - `internal/app/server.go`
  - `internal/core/router.go`、`internal/core/state.go`
  - `internal/wecom/message.go`
  - `internal/unraid/*`
  - `internal/qinglong/*`（新增）
  - `helloagents/wiki/*`（新增/更新模块文档与变更记录）
- **API:**
  - 对外 HTTP 入口保持不变：`/wecom/callback`
  - 内部新增青龙 OpenAPI 调用（对青龙面板发起 HTTP 请求）
- **数据:**
  - 仍以内存会话状态为主；新增青龙实例配置与 token 缓存（内存）

## 核心场景

### 需求: 多服务路由框架
**模块:** core / wecom
统一“服务入口→动作选择→参数输入/选择→确认→执行→回显”的通用流程，并允许新增 Provider 时尽量不改核心路由。

#### 场景: 入口菜单选择服务
用户在企微会话输入“菜单/帮助”，看到可用服务（Unraid/青龙），点击进入对应服务菜单。
- 预期结果：可进入服务菜单；会话状态被正确初始化；非白名单用户被拒绝。

#### 场景: 兼容现有 Unraid 入口
用户输入“容器/unraid”仍可直达 Unraid 动作菜单。
- 预期结果：原行为保持一致；不需要先选服务。

### 需求: 青龙多实例管理
**模块:** qinglong / core / wecom / config
支持配置多个青龙实例，并在会话内选择目标实例后执行操作。

#### 场景: 选择实例
用户进入青龙菜单后，先选择目标实例（如“家里青龙”“云端青龙”）。
- 预期结果：实例选择成功后进入动作菜单；会话中保存实例标识。

#### 场景: 查询/搜索任务
用户选择“任务列表/搜索任务”，系统返回任务列表（可按关键词过滤）并允许用户选择目标任务。
- 预期结果：任务展示清晰；用户可选择任务进入后续动作或直接执行动作。

#### 场景: 运行任务
用户选择任务后点击“运行”并二次确认。
- 预期结果：调用青龙 OpenAPI 执行；执行结果与耗时在企微回显。

#### 场景: 启用/禁用任务
用户对某个任务执行启用或禁用并二次确认。
- 预期结果：任务状态被更新；回显成功/失败原因。

#### 场景: 查看最近日志
用户选择任务后请求“查看日志”。
- 预期结果：返回最近日志摘要（避免过长消息）；失败时提示可诊断信息。

### 需求: 权限与安全
**模块:** core / qinglong / wecom
在企业微信侧与青龙侧均遵循最小权限与敏感信息保护原则。

#### 场景: 非白名单用户拒绝
不在 `auth.allowed_userids` 的用户发起请求。
- 预期结果：直接拒绝并提示无权限；不触发任何后端操作。

#### 场景: 事件 key 与输入校验
用户发送非预期的事件 key 或输入非法参数。
- 预期结果：不执行敏感操作；提示会话过期/输入不合法并引导重新开始。

## 风险评估
- **风险:** 方案2引入框架抽象，短期改动面更大，可能影响现有 Unraid 流程稳定性  
  **缓解:** 以“兼容优先”为原则迁移；为核心路由与 Provider 分发增加单元测试；保留旧入口关键词直达路径。
- **风险:** 企业微信卡片交互能力与按钮数量存在限制  
  **缓解:** 列表展示采用“分页/精简 + 关键词搜索 + 输入 ID”组合；关键动作始终提供二次确认。
- **风险:** 青龙 token 管理与多实例并发导致缓存/过期处理复杂  
  **缓解:** 每实例独立 token 缓存与过期刷新；请求层统一封装错误与超时；严格避免日志泄露 token 与 secret。
