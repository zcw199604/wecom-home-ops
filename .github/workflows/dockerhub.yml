name: Build and Push Docker Image

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read

env:
  IMAGE_NAME: ${{ secrets.DOCKERHUB_REPOSITORY != '' && secrets.DOCKERHUB_REPOSITORY || format('{0}/{1}', secrets.DOCKERHUB_USERNAME, github.event.repository.name) }}

jobs:
  docker:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=latest,enable={{is_default_branch}}
            type=sha,format=long

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: 企业微信通知 - 构建成功
        if: success()
        continue-on-error: true
        env:
          WECHAT_CORP_ID: ${{ secrets.WECHAT_CORP_ID }}
        run: |
          if [ -z "$WECHAT_CORP_ID" ]; then
            echo "未配置企业微信通知，跳过"
            exit 0
          fi

          WECHAT_API_URL="${{ secrets.WECHAT_API_URL }}"
          if [ -z "$WECHAT_API_URL" ]; then
            WECHAT_API_URL="https://qyapi.weixin.qq.com"
          fi
          WECHAT_API_URL="${WECHAT_API_URL%/}"

          ACCESS_TOKEN=$(
            curl -s "${WECHAT_API_URL}/cgi-bin/gettoken?corpid=${{ secrets.WECHAT_CORP_ID }}&corpsecret=${{ secrets.WECHAT_CORP_SECRET }}" \
              | grep -o '"access_token":"[^"]*"' \
              | cut -d'"' -f4
          )

          if [ -z "$ACCESS_TOKEN" ]; then
            echo "企业微信 access_token 获取失败，跳过"
            exit 0
          fi

          TAGS="${{ steps.meta.outputs.tags }}"
          TAGS_ONE_LINE=$(echo "$TAGS" | tr '\n' ',' | sed 's/,$//')

          curl -X POST "${WECHAT_API_URL}/cgi-bin/message/send?access_token=${ACCESS_TOKEN}" \
            -H 'Content-Type: application/json' \
            -d @- <<EOF
          {
            "touser": "${{ secrets.WECHAT_TO_USER }}",
            "msgtype": "markdown",
            "agentid": ${{ secrets.WECHAT_AGENT_ID }},
            "markdown": {
              "content": "## ✅ Docker 镜像构建成功\n>项目: **${{ github.event.repository.name }}**\n>分支: \`${{ github.ref_name }}\`\n>提交: [\`${GITHUB_SHA:0:7}\`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})\n>提交者: ${{ github.actor }}\n>镜像: \`${TAGS_ONE_LINE}\`\n\n[查看详情](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
            }
          }
          EOF

      - name: 企业微信通知 - 构建失败
        if: failure()
        continue-on-error: true
        env:
          WECHAT_CORP_ID: ${{ secrets.WECHAT_CORP_ID }}
        run: |
          if [ -z "$WECHAT_CORP_ID" ]; then
            echo "未配置企业微信通知，跳过"
            exit 0
          fi

          WECHAT_API_URL="${{ secrets.WECHAT_API_URL }}"
          if [ -z "$WECHAT_API_URL" ]; then
            WECHAT_API_URL="https://qyapi.weixin.qq.com"
          fi
          WECHAT_API_URL="${WECHAT_API_URL%/}"

          ACCESS_TOKEN=$(
            curl -s "${WECHAT_API_URL}/cgi-bin/gettoken?corpid=${{ secrets.WECHAT_CORP_ID }}&corpsecret=${{ secrets.WECHAT_CORP_SECRET }}" \
              | grep -o '"access_token":"[^"]*"' \
              | cut -d'"' -f4
          )

          if [ -z "$ACCESS_TOKEN" ]; then
            echo "企业微信 access_token 获取失败，跳过"
            exit 0
          fi

          curl -X POST "${WECHAT_API_URL}/cgi-bin/message/send?access_token=${ACCESS_TOKEN}" \
            -H 'Content-Type: application/json' \
            -d @- <<EOF
          {
            "touser": "${{ secrets.WECHAT_TO_USER }}",
            "msgtype": "markdown",
            "agentid": ${{ secrets.WECHAT_AGENT_ID }},
            "markdown": {
              "content": "## ❌ Docker 镜像构建失败\n>项目: **${{ github.event.repository.name }}**\n>分支: \`${{ github.ref_name }}\`\n>提交: [\`${GITHUB_SHA:0:7}\`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})\n>提交者: ${{ github.actor }}\n>失败原因: 请查看日志\n\n<font color=\\\"warning\\">[立即查看失败日志](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})</font>"
            }
          }
          EOF
